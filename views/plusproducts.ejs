<%- include('./partials/Header.ejs', {hidden: true}) %>

  <main style="padding: 4rem 0; background-color: #F1F5F9; min-height: 80vh;">
    <div class="container">

      <div style="display: grid; grid-template-columns: 260px 1fr; gap: 2rem;">

        <!-- Sidebar -->
        <aside>
          <%- include('./partials/SellerSidebar.ejs') %>
        </aside>

        <!-- Main Content -->
        <section
          style="background: white; padding: 2.5rem; border-radius: var(--border-radius-lg); box-shadow: var(--shadow-sm); border: 1px solid var(--color-border);">
          <div
            style="margin-bottom: 2rem; border-bottom: 1px solid var(--color-border); padding-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
            <div>
              <h2 style="font-size: 1.8rem; color: var(--color-text-primary); margin-bottom: 0.5rem;">Inventory
                Management</h2>
              <p style="color: var(--color-text-secondary); font-size: 0.9rem;">Manage your medical equipment catalog
              </p>
            </div>

            <a href="/seller/dashboard" class="btn btn-primary"
              style="padding: 0.8rem 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
              <i class="ri-add-line" style="font-size: 1.2rem;"></i> <span>List New Product</span>
            </a>
          </div>

          <% if(products && products.length> 0) { %>
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem;">
              <% products.forEach((fit)=> { %>
                <div class="product-card-admin"
                  style="border: 1px solid var(--color-border); border-radius: var(--border-radius-md); overflow: hidden; position: relative; background: white; transition: box-shadow 0.3s ease;">
                  <div
                    style="height: 220px; overflow: hidden; background: #fff; border-bottom: 1px solid var(--color-border); display: flex; align-items: center; justify-content: center; padding: 1rem;">
                    <img src="<%= fit.mainImage %>" alt="<%= fit.title %>"
                      style="max-width: 100%; max-height: 100%; object-fit: contain;">
                  </div>
                  <div style="padding: 1.2rem;">
                    <div style="margin-bottom: 1rem;">
                      <p style="font-size: 0.8rem; color: var(--color-text-secondary); text-transform: uppercase;">
                        Medical</p>
                      <h3
                        style="font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--color-text-primary);">
                        <%= fit.title %>
                      </h3>
                      <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-size: 1rem; font-weight: 700; color: var(--color-accent-primary);">PKR <%=
                            fit.price %></span>
                        <span
                          style="font-size: 0.85rem; color: var(--color-text-secondary); background: #f1f5f9; padding: 2px 8px; border-radius: 4px;">
                          <%= fit.salesCount || 0 %> Sold
                        </span>
                      </div>
                    </div>

                    <div style="display: flex; gap: 0.5rem;">
                      <button data-id="<%= fit._id %>"
                        class="btn btn-outline prod-feature <%= fit.tags && fit.tags.includes('featured') ? 'active' : '' %>"
                        style="flex: 1; padding: 0.5rem; font-size: 0.85rem; border-color: <%= fit.tags && fit.tags.includes('featured') ? '#F59E0B' : 'var(--color-border)' %>; color: <%= fit.tags && fit.tags.includes('featured') ? 'white' : '#F59E0B' %>; background: <%= fit.tags && fit.tags.includes('featured') ? '#F59E0B' : 'transparent' %>;">
                        <i
                          class="<%= fit.tags && fit.tags.includes('featured') ? 'ri-star-fill' : 'ri-star-line' %>"></i>
                        <%= fit.tags && fit.tags.includes('featured') ? 'Featured' : 'Feature' %>
                      </button>
                      <a href="/seller/edit/<%= fit._id %>" class="btn btn-outline"
                        style="flex: 1; padding: 0.5rem; font-size: 0.85rem; text-align: center; color: var(--color-text-primary); border-color: var(--color-border);"><i
                          class="ri-edit-line"></i> Edit</a>
                      <button data-id="<%= fit._id %>" class="btn btn-primary prod-delete"
                        style="flex: 1; padding: 0.5rem; font-size: 0.85rem; background: #ef4444; border-color: #ef4444;"><i
                          class="ri-delete-bin-line"></i></button>
                    </div>
                  </div>

                  <% if(!fit.isApproved) { %>
                    <div
                      style="position: absolute; top: 10px; right: 10px; background: #64748b; color: white; padding: 4px 10px; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">
                      Pending Review</div>
                    <% } %>
                </div>
                <% }) %>
            </div>
            <% } else { %>
              <div
                style="text-align: center; padding: 4rem; color: var(--color-text-secondary); background: #f8fafc; border-radius: var(--border-radius-md);">
                <i class="ri-medicine-bottle-line"
                  style="font-size: 4rem; margin-bottom: 1rem; display: block; color: var(--color-border);"></i>
                <h3 style="font-size: 1.5rem; margin-bottom: 0.5rem; color: var(--color-text-primary);">Empty Catalog
                </h3>
                <p style="margin-bottom: 2rem;">Start building your inventory by adding your first product.</p>
                <a href="/seller/dashboard" class="btn btn-primary">Add Product</a>
              </div>
              <% } %>

        </section>

      </div>
    </div>
  </main>
  <div id="confirmModal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div
      style="background: white; padding: 2rem; border-radius: var(--border-radius-md); width: 90%; max-width: 400px; box-shadow: var(--shadow-lg);">
      <h3 style="margin-bottom: 1rem; font-size: 1.2rem;">Delete Product?</h3>
      <p style="color: var(--color-text-secondary); margin-bottom: 1.5rem;">Are you sure you want to delete this
        product? This action cannot be undone.</p>
      <div style="display: flex; justify-content: flex-end; gap: 1rem;">
        <button id="cancelDelete" class="btn btn-outline" style="padding: 0.5rem 1rem;">Cancel</button>
        <button id="confirmDelete" class="btn btn-primary" style="padding: 0.5rem 1rem;">Yes, Delete</button>
      </div>
    </div>
  </div>

  <%- include('./partials/Footer.ejs') %>

    <script>
      document.addEventListener('DOMContentLoaded', () => {

        // ===== DELETE PRODUCT =====
        const deleteButtons = document.querySelectorAll('.prod-delete');
        const modal = document.getElementById('confirmModal');
        const cancelBtn = document.getElementById('cancelDelete');
        const confirmBtn = document.getElementById('confirmDelete');
        let pendingDelete = { id: null, card: null };

        deleteButtons.forEach(btn => {
          btn.addEventListener('click', () => {
            const id = btn.dataset.id;
            const card = btn.closest('.product-card-admin');
            pendingDelete = { id, card };
            modal.style.display = 'flex';
          });
        });

        cancelBtn.addEventListener('click', () => {
          modal.style.display = 'none';
          pendingDelete = { id: null, card: null };
        });

        confirmBtn.addEventListener('click', async () => {
          if (!pendingDelete.id) return;

          try {
            const res = await fetch(`/seller/products/${pendingDelete.id}`, {
              method: 'DELETE'
            });

            if (!res.ok) throw new Error('Delete failed');

            if (pendingDelete.card) pendingDelete.card.remove();
          } catch (err) {
            alert('Error deleting product');
          } finally {
            modal.style.display = 'none';
            pendingDelete = { id: null, card: null };
          }
        });


        // ===== FEATURE / PIN PRODUCT =====
        const featureButtons = document.querySelectorAll('.prod-feature');

        featureButtons.forEach(btn => {
          btn.addEventListener('click', async () => {
            const id = btn.dataset.id;

            try {
              const res = await fetch(`/seller/feature/${id}`, {
                method: 'POST'
              });

              const data = await res.json();

              if (data.success) {
                if (data.isFeatured) {
                  btn.style.background = '#FFD700';
                  btn.style.color = 'white';
                  btn.innerHTML = '<i class="ri-star-fill"></i> Pinned';
                } else {
                  btn.style.background = 'transparent';
                  btn.style.color = '#DAA520';
                  btn.innerHTML = '<i class="ri-star-line"></i> Pin';
                }
              }
            } catch (err) {
              console.error(err);
              alert('Error updating status');
            }
          });
        });

      });
    </script>


    <style>
      @media(max-width: 768px) {
        .container>div {
          grid-template-columns: 1fr !important;
        }
      }
    </style>