<%- include('./partials/Header.ejs') %>

  <main style="padding: 4rem 0; min-height: 60vh; background-color: var(--color-bg-primary);">
    <div class="container">
      <!-- Page Title & Context -->
      <div
        style="margin-bottom: 3rem; display: flex; justify-content: space-between; align-items: flex-end; flex-wrap: wrap; gap: 1rem;">
        <div>
          <span
            style="font-size: 0.9rem; color: var(--color-text-secondary); text-transform: uppercase; letter-spacing: 1px;">Medical
            Supplies</span>

          <% var searched=typeof searched !=='undefined' ? searched : false %>
            <% if (searched){ %>
              <h1 style="font-size: 2.5rem; color: var(--color-text-primary); margin-top: 0.5rem; line-height: 1.2;">
                Results for "<span style="color: var(--color-accent-primary);">
                  <%= request%>
                </span>"</h1>
              <% } else if (cat){ %>
                <h1
                  style="font-size: 2.5rem; color: var(--color-text-primary); margin-top: 0.5rem; line-height: 1.2; text-transform: capitalize;">
                  <%= displayCategory%>
                </h1>
                <% } else if (gen) {%>
                  <h1
                    style="font-size: 2.5rem; color: var(--color-text-primary); margin-top: 0.5rem; line-height: 1.2; text-transform: capitalize;">
                    <%= gender%>'s Section
                  </h1>
                  <% } %>

                    <p style="color: var(--color-text-secondary); margin-top: 0.5rem; font-size: 1rem;">
                      Showing <%= selectedProducts.length %> premium medical products
                    </p>
        </div>

        <!-- Filter (Only show if Category view) -->
        <% if (typeof cat !=='undefined' && cat) { %>
          <form action="/clothings/<%= category%>" method="get"
            style="display: flex; align-items: center; gap: 0.5rem; background: white; padding: 0.5rem; border-radius: var(--border-radius-md); border: 1px solid var(--color-border);">
            <label for="gender-filter"
              style="font-size: 0.9rem; font-weight: 500; color: var(--color-text-primary); padding-left: 0.5rem;">Filter
              Type:</label>
            <select id="gender-filter" name="gender"
              style="padding: 0.5rem; border: 1px solid var(--color-border); border-radius: 4px; background: white; font-family: var(--font-body); outline: none;">
              <option value="all">All Types</option>
              <option value="boys">Standard</option>
              <option value="girls">Premium</option>
            </select>
            <button type="submit" class="btn btn-primary"
              style="padding: 0.5rem 1.5rem; font-size: 0.9rem;">Apply</button>
          </form>
          <% } %>
      </div>

      <!-- Product Grid -->
      <% if(selectedProducts.length> 0) { %>
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 2.5rem;">
          <% selectedProducts.forEach((fit)=> { %>
            <div class="product-card" onclick="window.location.href='/products/<%= fit._id %>'"
              style="display: flex; flex-direction: column; cursor: pointer; position: relative; background: white; border-radius: var(--border-radius-lg); overflow: hidden; border: 1px solid transparent; transition: all 0.3s ease;">

              <div
                style="position: relative; height: 250px; overflow: hidden; background: #fff; padding: 1rem; display: flex; align-items: center; justify-content: center; border-bottom: 1px solid var(--color-border);">

                <% if (fit.discountInfo && fit.discountInfo.percent> 0) { %>
                  <span
                    style="position: absolute; top: 1rem; left: 1rem; background: #ef4444; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: 600; z-index: 10;">
                    -<%= fit.discountInfo.percent %>%
                  </span>
                  <% } %>

                    <img src="<%= fit.mainImage %>" alt="<%= fit.title %>"
                      style="max-width: 100%; max-height: 100%; object-fit: contain; transition: transform 0.3s ease;">
              </div>

              <div style="display: flex; flex-direction: column; padding: 1.2rem; flex-grow: 1;">
                <div style="flex-grow: 1;">
                  <p
                    style="font-size: 0.8rem; color: var(--color-text-secondary); margin-bottom: 0.3rem; text-transform: uppercase; letter-spacing: 0.5px;">
                    Medical Grade</p>
                  <h3
                    style="font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem; line-height: 1.4; color: var(--color-text-primary); height: 3rem; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">
                    <%= fit.title %>
                  </h3>

                  <!-- Colors -->
                  <% if (fit.color && Array.isArray(fit.color)) { %>
                    <div style="display: flex; gap: 6px; margin-bottom: 0.8rem;">
                      <% fit.color.forEach(c=> { %>
                        <span
                          style="width: 12px; height: 12px; rounded-full; background-color: <%= c %>; display: inline-block; border-radius: 50%; border: 1px solid var(--color-border);"></span>
                        <% }) %>
                    </div>
                    <% } %>

                      <!-- Price -->
                      <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 1rem; flex-wrap: wrap;">
                        <% if (fit.discountInfo && fit.discountInfo.percent> 0) { %>
                          <span style="color: var(--color-text-primary); font-weight: 700; font-size: 1.2rem;">PKR <%=
                              fit.discountInfo.finalPrice %></span>
                          <span
                            style="text-decoration: line-through; color: var(--color-text-secondary); font-size: 0.9rem;">PKR
                            <%= fit.price %></span>

                          <% } else { %>
                            <span style="font-weight: 700; color: var(--color-text-primary); font-size: 1.2rem;">PKR <%=
                                fit.price %></span>
                            <% } %>
                      </div>
                </div>

                <div style="margin-top: auto;">
                  <button data-fitId="<%= fit._id%>" class="btn btn-outline add-btn"
                    style="width: 100%; justify-content: center; padding: 0.8rem;">
                    <i class="ri-shopping-cart-2-line" style="margin-right: 5px;"></i> Add to Cart
                  </button>
                </div>
              </div>
            </div>
            <% }) %>
        </div>
        <% } else { %>
          <div style="padding: 6rem 0; text-align: center;">
            <div
              style="width: 80px; height: 80px; background: var(--color-bg-secondary); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem;">
              <i class="ri-search-2-line" style="font-size: 2.5rem; color: var(--color-text-secondary);"></i>
            </div>
            <h3 style="color: var(--color-text-primary); font-size: 1.5rem; margin-bottom: 0.5rem;">No products found
            </h3>
            <p style="color: var(--color-text-secondary); margin-bottom: 2rem;">Try adjusting your search or filter to
              find what you're looking for.</p>
            <a href="/" class="btn btn-primary" style="padding: 0.8rem 2rem;">Back to Home</a>
          </div>
          <% } %>
    </div>
  </main>

  <%- include('./partials/Footer.ejs') %>
    <script src="/javascripts/index.js"></script>
    <script>
      // Re-initialize cart logic if needed, referencing the external script logic 
      // or ensuring the external script attaches listeners correctly.
      // Assuming addToCart() is defined in index.js and attaches listeners.
      if (typeof addToCart === 'function') {
        addToCart();
      }
    </script>